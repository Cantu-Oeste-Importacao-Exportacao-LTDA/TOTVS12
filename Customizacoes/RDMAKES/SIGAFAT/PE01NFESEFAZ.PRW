#INCLUDE "rwmake.ch"
#INCLUDE "topconn.ch"
#INCLUDE "protheus.ch"
/*
эээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээээ
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
╠╠иммммммммммяммммммммммкмммммммямммммммммммм`ммммммммкммммммямммммммммммм╩╠╠
╠╠╨Programa  ЁPE01NFESEFAZ ╨Autor ЁTotvs Cascavel     ╨ Data Ё 03/12/2015 ╨╠╠
╠╠лммммммммммьммммммммммймммммммоммммммммммммммммммммйммммммоммммммммммммм╧╠╠
╠╠╨Desc.     ЁPonto de entrada executado na rotina NFESEFAZ.PRW antes da  ╨╠╠
╠╠╨          Ёmontagem e envio do XML da NFe ao Sefaz.                    ╨╠╠
╠╠╨          ЁUtilizado para tratar regras personalizadas.                ╨╠╠
╠╠лммммммммммьмммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╧╠╠
╠╠╨Uso       ЁEspecifico Cliente TOTVS                                    ╨╠╠
╠╠хммммммммммомммммммммммммммммммммммммммммммммммммммммммммммммммммммммммм╪╠╠
╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠╠
ъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъъ
*/
*---------------------------------------------------------------------------*
User Function PE01NFESEFAZ()
*---------------------------------------------------------------------------*
Local aAreas		:= {}
Local aRetorno		:= {}
Local aProd			:= PARAMIXB[1]
Local aDest			:= PARAMIXB[4] 
Local aNota   		:= PARAMIXB[5]
Local aInfItem		:= PARAMIXB[6]
Local aDup			:= PARAMIXB[7]
Local aTransp		:= PARAMIXB[8]
Local aEntrega		:= PARAMIXB[9]
Local aRetirada		:= PARAMIXB[10]
Local aVeiculo		:= PARAMIXB[11] 
Local aReboque		:= PARAMIXB[12] 
Local aNfVincRur	:= PARAMIXB[13]
Local aEspVol 		:= PARAMIXB[14]
Local aNfVinc 		:= PARAMIXB[15]
Local AdetPag 		:= PARAMIXB[16]

Local cCliFor		:= ""
Local cLoja			:= ""
Local nI			:= 0

Private cMensCli	:= PARAMIXB[2]
Private cMensFis	:= PARAMIXB[3]

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд
//ЁSalva posicionamento das tabelas                      Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддд
aAdd( aAreas, SA1->(GetArea()) )
aAdd( aAreas, SA2->(GetArea()) )
aAdd( aAreas, SB1->(GetArea()) )
aAdd( aAreas, SBM->(GetArea()) )
aAdd( aAreas, SF4->(GetArea()) )
aAdd( aAreas, SE4->(GetArea()) )
aAdd( aAreas, SD2->(GetArea()) )
aAdd( aAreas, SF2->(GetArea()) )
aAdd( aAreas, SD1->(GetArea()) )
aAdd( aAreas, SF1->(GetArea()) )
aAdd( aAreas, SC5->(GetArea()) )
aAdd( aAreas, SC6->(GetArea()) )
aAdd( aAreas, SC7->(GetArea()) )
aAdd( aAreas, GetArea() )	//Area Atual adicionar sempre por Зltimo

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд
//ЁExecuta regras quando se trata de nota fiscal de saМdaЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддд
If aNota[4] == "1"
	dbSelectArea("SF2")
	SF2->(dbSetOrder(1))
	SF2->(dbGoTop())
	dbSeek(xFilial("SF2") + aNota[2] + aNota[1],.T.) 
	
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд
	//ЁObtИm cСdigo do fornecedor\cliente do documento fiscalЁ
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддд
	If aNota[5] $ "B\D"
		dbSelectArea("SA2")
		SA2->(dbSetOrder(1))
		SA2->(dbGoTop())
		If SA2->(dbSeek(xFilial("SA2") + SF2->F2_CLIENTE + SF2->F2_LOJA))
			cCliFor		:= SA2->A2_COD
			cLoja		:= SA2->A2_LOJA  
		EndIf                      
	Else                           
		dbSelectArea("SA1")
		SA1->(dbSetOrder(1))
		SA1->(dbGoTop())
		If SA1->(dbSeek(xFilial("SA1") + SF2->F2_CLIENTE + SF2->F2_LOJA))
		    cCliFor		:= SA1->A1_COD
		    cLoja		:= SA1->A1_LOJA
		EndIf
				
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
		//Ё Mesagem sobre Regime Especial de TributaГЦo do cliente            Ё
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
		If FieldPos("A1_X_REGES") > 0
			If !Empty(SA1->A1_X_REGES)
				cMensCli += " Operacao dispensada da Substituicao Tributaria conforme Regime Especial N╨: "+ALLTRIM(SA1->A1_X_REGES)
			Endif
		Endif
	
	EndIf
EndIf	
	/* Abaixo exemplo para laГo de repetiГЦo nos produtos.
	
	//зддддддддддддддддддддддддддддддддддддддддддддд
	//ЁGarante posicionamento do documento de saМdaЁ
	//юддддддддддддддддддддддддддддддддддддддддддддд
	dbSelectArea("SF2")
	SF2->(dbSetOrder(1))
	SF2->(dbGoTop())
	If SF2->(dbSeek(xFilial("SF2") + aNota[2] + aNota[1] + cCliFor + cLoja)) 
		
		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
		//ЁExecuta laГo de processamento de todos os itens do documento fiscalЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
		For nI := 1 To Len(aInfItem)
	
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд
			//ЁPosiciona no item do documento fiscal conforme arrayЁ
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддд
			dbSelectArea("SD2")
			SD2->(dbSetOrder(3))
			SD2->(dbGoTop())
			//If SD2->(dbSeek(xFilial("SD2") + SF2->F2_DOC + SF2->F2_SERIE + SF2->F2_CLIENTE + SF2->F2_LOJA + SF2->F2_ESPECIE + aProd[nI][2] + aInfItem[nI][4]))
			If SD2->(dbSeek(xFilial("SD2") + SF2->F2_DOC + SF2->F2_SERIE + SF2->F2_CLIENTE + SF2->F2_LOJA + aProd[nI][2] + aInfItem[nI][4]))
				
				//здддддддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no cabeГalho do pedido de vendaЁ
				//юдддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SC5")
				SC5->(dbSetOrder(1))
				SC5->(dbGoTop())
				SC5->(dbSeek(xFilial("SC5") + SD2->D2_PEDIDO))
				
				//зддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no item do pedido de vendaЁ
				//юддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SC6")
				SC6->(dbSetOrder(1))
				SC6->(dbGoTop())
				SC6->(dbSeek(xFilial("SC6") + SD2->D2_PEDIDO + SD2->D2_ITEMPV))
				
				//зддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona na Condicao de Pagamento  Ё
				//юддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SE4")
				SE4->(dbSetOrder(1))
				SE4->(dbGoTop())
				SE4->(dbSeek(xFilial("SE4")+SC5->C5_CONDPAG))
				
				//зддддддддддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no TES do item do documento fiscalЁ
				//юддддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SF4")
				SF4->(dbSetOrder(1))
				SF4->(dbGoTop())
				SF4->(dbSeek(xFilial("SF4") + SD2->D2_TES))
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд
				//ЁCarrega informaГУes vinculadas ao cadastro do produtoЁ
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SB1")
				SB1->(dbSetOrder(1))
				SB1->(dbGoTop())
				SB1->(dbSeek(xFilial("SB1") + SD2->D2_COD))
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no grupo de produto do item do documento fiscalЁ
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SBM")
				SBM->(dbSetOrder(1))
				SBM->(dbGoTop())
				SBM->(dbSeek(xFilial("SBM") + SB1->B1_GRUPO))
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				//ЁMENSAGENS 								                          Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				cMensFis += U_X010A01("MSGFIS","S")
				cMensCli += U_X010A01("MSGCLI","S")
			EndIf
		Next nI
		
	EndIf

Else
	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
	//ЁExecuta regras quando se trata de nota fiscal de entradaЁ
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддддд

	//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд
	//ЁObtИm cСdigo do fornecedor\cliente do documento fiscalЁ
	//юддддддддддддддддддддддддддддддддддддддддддддддддддддддд
	If !aNota[5] $ "B\D"
		dbSelectArea("SA2")
		SA2->(dbSetOrder(1))
		SA2->(dbGoTop())
		If SA2->(dbSeek(xFilial("SA2") + SF1->F1_FORNECE + SF1->F1_LOJA))
			cCliFor	:= SA2->A2_COD
			cLoja		:= SA2->A2_LOJA
			//aDest[2]	:= ALLTRIM(SA2->A2_NOME)+"  "+SA2->A2_COD+"/"+SA2->A2_X_LINHA
		EndIf                      
	Else                           
		dbSelectArea("SA1")
		SA1->(dbSetOrder(1))
		SA1->(dbGoTop())
		If SA1->(dbSeek(xFilial("SA1") + SF1->F1_FORNECE + SF1->F1_LOJA))
			cCliFor	:= SA1->A1_COD
		   	cLoja		:= SA1->A1_LOJA
			//aDest[2]	:= AllTrim(SA1->A1_NOME)+"  "+SA1->A1_COD+"/"+SA1->A1_LOJA
		EndIf
	EndIf
	
	//зддддддддддддддддддддддддддддддддддддддддддддддд
	//ЁGarante posicionamento do documento de entradaЁ
	//юддддддддддддддддддддддддддддддддддддддддддддддд
	dbSelectArea("SF1")
	SF1->(dbSetOrder(1))
	SF1->(dbGoTop())
	If SF1->(dbSeek(xFilial("SF2") + aNota[2] + aNota[1] + cCliFor + cLoja))

		//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
		//ЁExecuta laГo de processamento de todos os itens do documento fiscalЁ
		//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
		For nI := 1 To Len(aInfItem)
	
			//зддддддддддддддддддддддддддддддддддддддддддддддддддддд
			//ЁPosiciona no item do documento fiscal conforme arrayЁ
			//юддддддддддддддддддддддддддддддддддддддддддддддддддддд
			dbSelectArea("SD1")
			SD1->(dbSetOrder(1))
			SD1->(dbGoTop())
			If SD1->(dbSeek(xFilial("SD1") + SF1->F1_DOC + SF1->F1_SERIE + SF1->F1_FORNECE + SF1->F1_LOJA + aProd[nI][2] + aInfItem[nI][4]))
				
				//зддддддддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no no pedido de compra vinculadoЁ
				//юддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SC7")
				SC7->(dbSetOrder(1))
				SC7->(dbGoTop())
				SC7->(dbSeek(xFilial("SC7") + SD1->D1_PEDIDO + SD1->D1_ITEMPC))
								
				//зддддддддддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no TES do item do documento fiscalЁ
				//юддддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SF4")
				SF4->(dbSetOrder(1))
				SF4->(dbGoTop())
				SF4->(dbSeek(xFilial("SF4") + SD1->D1_TES))
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддд
				//ЁCarrega informaГУes vinculadas ao cadastro do produtoЁ
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SB1")
				SB1->(dbSetOrder(1))
				SB1->(dbGoTop())
				SB1->(dbSeek(xFilial("SB1") + SD1->D1_COD))
				
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				//ЁPosiciona no grupo de produto do item do documento fiscalЁ
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				dbSelectArea("SBM")
				SBM->(dbSetOrder(1))
				SBM->(dbGoTop())
				SBM->(dbSeek(xFilial("SBM") + SB1->B1_GRUPO))
			
				//здддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				//ЁMensagens                                                          Ё
				//юдддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддддд
				cMensFis += U_X010A01("MSGFIS","E")
				cMensCli += U_X010A01("MSGCLI","E")
			EndIf
		Next nI
	EndIf
EndIf

*/
	
//зддддддддддддддддддддддддддддддддддддддддддддддддд
//ЁCompoe array de retorno com os dados manipuladosЁ
//юддддддддддддддддддддддддддддддддддддддддддддддддд
AADD(aRetorno, aProd)
AADD(aRetorno, cMensCli)
AADD(aRetorno, cMensFis)
AADD(aRetorno, aDest)
AADD(aRetorno, aNota)  
AADD(aRetorno, aInfItem)
AADD(aRetorno, aDup)
AADD(aRetorno, aTransp)
AADD(aRetorno, aEntrega)
AADD(aRetorno, aRetirada)
AADD(aRetorno, aVeiculo)
AADD(aRetorno, aReboque)
AADD(aRetorno, aNfVincRur)
AADD(aRetorno, aEspVol)
AADD(aRetorno, aNfVinc)
AADD(aRetorno, AdetPag)

//зддддддддддддддддддддддддддддддддддддддддддддддддддддддд
//ЁRestaura posicionamento das tabelas                    Ё
//юддддддддддддддддддддддддддддддддддддддддддддддддддддддд
aEval(aAreas, {|x| RestArea(x) })

Return aRetorno
